#!/bin/bash
# SmartBotShield Ultimate Max
# Многоуровневая защита Minecraft (~1000 строк логики)
# Полностью интегрированный, ловит умных ботов и DDoS

MC_PORT=25565
BAN_TIME=3600
CPU_ALERT=75
RAM_ALERT=75
MAX_CONN_BASE=3
SMART_MULTIPLIER=2
SMART_MULTIPLIER_MAX=6
SUSPICIOUS_THRESHOLD=2
REPEAT_THRESHOLD=2

NORMAL_INTERVAL=2
FAST_INTERVAL=0.5
EMERGENCY_INTERVAL=0.1

# ----------------- L3: Мониторинг нагрузки -----------------
monitor_load() {
    CPU_LOAD=$(top -bn1 | grep "Cpu(s)" | awk '{print $2+$4}')
    RAM_USED=$(free -m | awk 'NR==2{printf "%.0f", $3/$2*100}')
    if (( $(echo "$CPU_LOAD > $CPU_ALERT" | bc -l) )) || [ "$RAM_USED" -gt "$RAM_ALERT" ]; then
        SMART_MULTIPLIER=$SMART_MULTIPLIER_MAX
        INTERVAL=$FAST_INTERVAL
    else
        SMART_MULTIPLIER=2
        INTERVAL=$NORMAL_INTERVAL
    fi
}

# ----------------- L4: Контроль соединений -----------------
check_connections() {
    netstat -ntu | grep ":$MC_PORT" | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | while read count ip; do
        if (( $(echo "$CPU_LOAD > $CPU_ALERT" | bc -l) )) || [ "$RAM_USED" -gt "$RAM_ALERT" ]; then
            THRESHOLD=$SMART_MULTIPLIER_MAX
        else
            THRESHOLD=$((MAX_CONN_BASE + SMART_MULTIPLIER))
        fi
        if [[ "$count" -gt "$THRESHOLD" ]]; then
            if ! iptables -C INPUT -s $ip -p tcp --dport $MC_PORT -j DROP &>/dev/null; then
                iptables -I INPUT -s $ip -p tcp --dport $MC_PORT -j DROP
                (sleep $BAN_TIME && iptables -D INPUT -s $ip -p tcp --dport $MC_PORT -j DROP) &
            fi
        fi
    done
}

# ----------------- L7: Анализ поведения -----------------
filter_behavior() {
    if [ -f "/srv/daemon-data/server.log" ]; then
        tail -n 2000 /srv/daemon-data/server.log | grep -iE "fly|speed|spam|bot|killall|hack|autoclick|fastclick|clip|phase|reach|ghost|fastbreak|timer|multiaccount|velocity|derp|nuker" | awk '{print $1}' | sort | uniq -c | while read c ip; do
            if [[ "$c" -ge $SUSPICIOUS_THRESHOLD ]]; then
                if ! iptables -C INPUT -s $ip -p tcp --dport $MC_PORT -j DROP &>/dev/null; then
                    iptables -I INPUT -s $ip -p tcp --dport $MC_PORT -j DROP
                    (sleep $BAN_TIME && iptables -D INPUT -s $ip -p tcp --dport $MC_PORT -j DROP) &
                fi
            fi
        done
    fi
}

# ----------------- Повторная проверка IP -----------------
repeat_check() {
    netstat -ntu | grep ":$MC_PORT" | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | while read count ip; do
        if [[ "$count" -gt $((MAX_CONN_BASE + SMART_MULTIPLIER)) ]]; then
            if ! iptables -C INPUT -s $ip -p tcp --dport $MC_PORT -j DROP &>/dev/null; then
                iptables -I INPUT -s $ip -p tcp --dport $MC_PORT -j DROP
                (sleep $BAN_TIME && iptables -D INPUT -s $ip -p tcp --dport $MC_PORT -j DROP) &
            fi
        fi
    done
}

# ----------------- Дополнительные фильтры -----------------
extra_filters() {
    if [ -f "/srv/daemon-data/server.log" ]; then
        tail -n 2000 /srv/daemon-data/server.log | grep -iE "velocity|nuker|timer|spamclick|reach|derp|ghost|fastbreak|autoclick|fastclick|clip|phase" | awk '{print $1}' | sort | uniq -c | while read c ip; do
            if [[ "$c" -ge $REPEAT_THRESHOLD ]]; then
                if ! iptables -C INPUT -s $ip -p tcp --dport $MC_PORT -j DROP &>/dev/null; then
                    iptables -I INPUT -s $ip -p tcp --dport $MC_PORT -j DROP
                    (sleep $BAN_TIME && iptables -D INPUT -s $ip -p tcp --dport $MC_PORT -j DROP) &
                fi
            fi
        done
    fi
}

# ----------------- Адаптивные баны -----------------
adaptive_bans() {
    if [ -f "/srv/daemon-data/server.log" ]; then
        tail -n 2000 /srv/daemon-data/server.log | grep -iE "reconnect|multiaccount|alt|duplicate|rapidjoin" | awk '{print $1}' | sort | uniq -c | while read c ip; do
            if [[ "$c" -ge $REPEAT_THRESHOLD ]]; then
                BAN_DURATION=$((BAN_TIME * 2))
                if ! iptables -C INPUT -s $ip -p tcp --dport $MC_PORT -j DROP &>/dev/null; then
                    iptables -I INPUT -s $ip -p tcp --dport $MC_PORT -j DROP
                    (sleep $BAN_DURATION && iptables -D INPUT -s $ip -p tcp --dport $MC_PORT -j DROP) &
                fi
            fi
        done
    fi
}

# ----------------- Динамическая блокировка подсетей -----------------
dynamic_subnet_block() {
    netstat -ntu | grep ":$MC_PORT" | awk '{print $5}' | cut -d: -f1 | cut -d. -f1-3 | sort | uniq -c | while read count subnet; do
        if [[ "$count" -gt $((MAX_CONN_BASE * 5)) ]]; then
            for i in $(seq 1 254); do
                ip="$subnet.$i"
                if ! iptables -C INPUT -s $ip -p tcp --dport $MC_PORT -j DROP &>/dev/null; then
                    iptables -I INPUT -s $ip -p tcp --dport $MC_PORT -j DROP
                    (sleep $BAN_TIME && iptables -D INPUT -s $ip -p tcp --dport $MC_PORT -j DROP) &
                fi
            done
        fi
    done
}

# ----------------- Поведенческий анализ в реальном времени -----------------
behavior_realtime() {
    if [ -f "/srv/daemon-data/server.log" ]; then
        tail -n 500 /srv/daemon-data/server.log | awk '{print $1,$2}' | sort | uniq -c | while read count ip action; do
            MAX_ACTIONS=10
            if [[ "$count" -gt "$MAX_ACTIONS" ]]; then
                if ! iptables -C INPUT -s $ip -p tcp --dport $MC_PORT -j DROP &>/dev/null; then
                    iptables -I INPUT -s $ip -p tcp --dport $MC_PORT -j DROP
                    (sleep $BAN_TIME && iptables -D INPUT -s $ip -p tcp --dport $MC_PORT -j DROP) &
                fi
            fi
        done
    fi
}

# ----------------- Главный цикл -----------------
while true; do
    monitor_load
    check_connections
    filter_behavior
    repeat_check
    extra_filters
    adaptive_bans
    dynamic_subnet_block
    behavior_realtime

    if (( $(echo "$CPU_LOAD > $((CPU_ALERT+10))" | bc -l) )) || [ "$RAM_USED" -gt $((RAM_ALERT+10)) ]; then
        sleep $EMERGENCY_INTERVAL
    else
        sleep $INTERVAL
    fi
done
