#!/bin/bash
# Nano Script: SmartBotShield Ultimate vFinal
# Умное усиление L3/L4/L7 + блокировка умных ботов с циклом
# Каждая функция с аннотацией, что она усиливает и для чего

# -------------------- НАСТРОЙКИ --------------------
MC_PORT=25565
BAN_TIME=3600
CPU_ALERT=85
RAM_ALERT=85
MAX_CONN_BASE=5
SMART_MULTIPLIER=2
SMART_MULTIPLIER_MAX=5
SUSPICIOUS_THRESHOLD=5

NORMAL_INTERVAL=2
FAST_INTERVAL=0.5

# --- L4: Усиление защиты соединений ---
check_connections_smart() {
    netstat -ntu | grep ":$MC_PORT" | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | while read count ip; do
        if (( $(echo "$CPU_LOAD > $CPU_ALERT" | bc -l) || "$RAM_USED" -gt "$RAM_ALERT" )); then
            THRESHOLD=$SMART_MULTIPLIER_MAX
        else
            THRESHOLD=$((MAX_CONN_BASE + SMART_MULTIPLIER))
        fi

        if [[ "$count" -gt "$THRESHOLD" ]]; then
            iptables -I INPUT -s $ip -p tcp --dport $MC_PORT -j DROP
            echo "IP $ip заблокирован за превышение соединений ($count > $THRESHOLD)"
            (sleep $BAN_TIME && iptables -D INPUT -s $ip -p tcp --dport $MC_PORT -j DROP &&
             echo "IP $ip разблокирован") &
        fi
    done
}

# --- L7: Усиление защиты прикладного уровня ---
filter_minecraft_smart() {
    if [ -f "/srv/daemon-data/server.log" ]; then
        tail -n 200 /srv/daemon-data/server.log | grep -iE "fly|killall|spam|bot|speed|hack" | awk '{print $1}' | sort | uniq -c | while read c ip; do
            if [[ "$c" -gt $SUSPICIOUS_THRESHOLD ]]; then
                iptables -I INPUT -s $ip -p tcp --dport $MC_PORT -j DROP
                echo "IP $ip заблокирован за подозрительные действия ($c раз)"
                (sleep $BAN_TIME && iptables -D INPUT -s $ip -p tcp --dport $MC_PORT -j DROP &&
                 echo "IP $ip разблокирован") &
            fi
        done
    fi
}

# --- L3: Усиление защиты уровня нагрузки ---
monitor_load_smart() {
    CPU_LOAD=$(top -bn1 | grep "Cpu(s)" | awk '{print $2 + $4}')
    RAM_USED=$(free -m | awk 'NR==2{printf "%.0f", $3/$2 * 100}')

    if (( $(echo "$CPU_LOAD > $CPU_ALERT" | bc -l) )) || [ "$RAM_USED" -gt "$RAM_ALERT" ]; then
        SMART_MULTIPLIER=$SMART_MULTIPLIER_MAX
        INTERVAL=$FAST_INTERVAL
    else
        SMART_MULTIPLIER=2
        INTERVAL=$NORMAL_INTERVAL
    fi
}

# -------------------- ГЛАВНЫЙ ЦИКЛ --------------------
while true; do
    monitor_load_smart
    check_connections_smart
    filter_minecraft_smart
    sleep $INTERVAL
done
